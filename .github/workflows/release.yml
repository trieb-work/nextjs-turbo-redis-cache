name: Release

on:
  push:
    branches:
      - main
      - beta
      
permissions:
  contents: write
  pull-requests: write
  deployments: write
  packages: write
  statuses: write
  issues: write
  actions: write
  discussions: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install pnpm
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Verify the integrity of provenance attestations and registry signatures for installed dependencies
        run: npm audit signatures

      - name: Build project
        run: pnpm build

      - name: Show npm provenance config
        env:
          NPM_CONFIG_PROVENANCE: 'true'
        run: |
          node -v
          npm -v
          echo "NPM_CONFIG_PROVENANCE=$NPM_CONFIG_PROVENANCE"
          npm config get provenance
          node -e "console.log('package.json publishConfig.provenance=', require('./package.json')?.publishConfig?.provenance)"

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub token for Semantic Release
          NPM_CONFIG_PROVENANCE: 'true'
        run: pnpm exec semantic-release

      - name: Diagnostics (OIDC + npm config)
        env:
          NPM_CONFIG_PROVENANCE: 'true'
        run: |
          echo "github.ref_name=${{ github.ref_name }}"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:+set}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+set}"
          echo "CI=${CI:-unset}"
          npm config get registry
          npm config get provenance

      - name: Exchange GitHub OIDC token for npm token
        id: npm-oidc
        env:
          NPM_PACKAGE_NAME: '@trieb.work/nextjs-turbo-redis-cache'
        run: |
          node <<'NODE'
          const fs = require('node:fs');

          const pkg = process.env.NPM_PACKAGE_NAME;
          const reqUrl = process.env.ACTIONS_ID_TOKEN_REQUEST_URL;
          const reqToken = process.env.ACTIONS_ID_TOKEN_REQUEST_TOKEN;

          if (!pkg || !reqUrl || !reqToken) {
            console.error('Missing required env for OIDC token retrieval');
            process.exit(1);
          }

          const audience = 'npm:registry.npmjs.org';
          const url = reqUrl + (reqUrl.includes('?') ? '&' : '?') + 'audience=' + encodeURIComponent(audience);

          (async () => {
            const idRes = await fetch(url, { headers: { Authorization: 'Bearer ' + reqToken } });
            if (!idRes.ok) {
              console.error('Failed to fetch GitHub OIDC token:', idRes.status, await idRes.text());
              process.exit(1);
            }

            const idBody = await idRes.json();
            const idToken = idBody.value;

            const exUrl =
              'https://registry.npmjs.org/-/npm/v1/oidc/token/exchange/package/' + encodeURIComponent(pkg);
            const exRes = await fetch(exUrl, {
              method: 'POST',
              headers: { Authorization: 'Bearer ' + idToken },
            });

            const exText = await exRes.text();
            if (!exRes.ok) {
              console.error('OIDC token exchange with npm failed:', exRes.status, exText);
              process.exit(1);
            }

            const exBody = JSON.parse(exText);
            const npmToken = exBody.token;
            if (!npmToken) {
              console.error('npm exchange response missing token');
              process.exit(1);
            }

            fs.appendFileSync(process.env.GITHUB_OUTPUT, `node_auth_token=${npmToken}\n`);
            console.log('OIDC token exchange with npm registry succeeded');
          })().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

      - name: Publish to npm (Trusted Publishing)
        env:
          NPM_CONFIG_PROVENANCE: 'true'
          NPM_DIST_TAG: ${{ github.ref_name == 'beta' && 'beta' || 'latest' }}
          NODE_AUTH_TOKEN: ${{ steps.npm-oidc.outputs.node_auth_token }}
        run: npm publish --provenance --access public --tag $NPM_DIST_TAG --registry https://registry.npmjs.org/ --loglevel verbose
